<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html>
<head>
	<title>Ekta Chain</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no,user-scalable=no" />
	<meta name="format-detection" content="telephone=no" />
	<link rel="icon" href="img/favicon.svg"/>
	<link rel="stylesheet" href="css/font-awesome-4.7.0/css/font-awesome.min.css" />
	<link rel="stylesheet" href="css/index.css" />
</head>

<body>
	<div class="div_full">
		<div class="div_title">Ekta Bridge</div>
		<div class="div_tabs">
			<nav>
				<div class="">
					<a href="#" class="active">Bridge</a>
					<a href="#/bsc/farm">Staking</a>
				</div>
			</nav>
		</div>
		<div class="div_main">
			<div class="div_content">
				<label>Swap</label>
				<div class="div_item">
					<div class="div_item_title">From</div>
					
					<div class="div_item_coin">
						<div>
							<div class="div_from_btn">
								<img id="img_from"/>
								<img id="img_from_chain" class="min-img">
							</div>
						</div>
						<input id="input_from_amount" type="text" inputmode="decimal" placeholder="0.0"/>
					</div>
					
					<div class="div_item_address">
						<input id="input_from_addr" type="text" placeholder="from address" />
					</div>
				</div>
				
				<div class="div_exchange">
					<span>
						<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 489.389 489.389" xml:space="preserve">
							<g>
								<g>
									<path d="M261.294,326.102c-8.3-7.3-21.8-6.2-29.1,2.1l-77,86.8v-346.9c0-11.4-9.4-20.8-20.8-20.8s-20.8,9.4-20.8,20.8v346.9 l-77-86.8c-8.3-8.3-20.8-9.4-29.1-2.1c-8.3,8.3-9.4,20.8-2.1,29.1l113.4,126.9c8.5,10.5,23.5,8.9,30.2,0l114.4-126.9 C270.694,347.002,269.694,333.402,261.294,326.102z"></path>
	            					<path d="M483.994,134.702l-112.4-126.9c-10-10.1-22.5-10.7-31.2,0l-114.4,126.9c-7.3,8.3-6.2,21.8,2.1,29.1 c12.8,10.2,25.7,3.2,29.1-2.1l77-86.8v345.9c0,11.4,9.4,20.8,20.8,20.8s20.8-8.3,20.8-19.8v-346.8l77,86.8 c8.3,8.3,20.8,9.4,29.1,2.1C490.194,155.502,491.294,143.002,483.994,134.702z"></path>
	        					</g>
	        				</g>
						</svg>
					</span>
				</div>
				
				<div class="div_item">
					<div class="div_item_title">To</div>
					
					<div class="div_item_coin">
						<div>
							<div class="div_to_btn">
								<img id="img_to"/>
								<img id="img_to_chain" class="min-img">
							</div>
						</div>
						<input id="input_to_amount" type="text" disabled="disabled" inputmode="decimal" placeholder="0.0"/>
					</div>
					
					<div class="div_item_address">
						<input id="input_to_addr" type="text" placeholder="to address" />
					</div>
				</div>
				
				<button class="btn_submit">Swap</button>
			</div>
			
			<div class="div_footer">
				<div>
					<div class="left">Fee</div>
					<div class="right">0%</div>
				</div>
				<div>
					<div class="left">Estimated processing time</div>
					<div class="right">~10 minutes</div>
				</div>
			</div>
		</div>
		
		<div class="div_overlay" style="display: none;"></div>
		<div class="div_window" id="div_from_select" style="display: none;"></div>
		<div class="div_window" id="div_to_select" style="display: none;"></div>
		<div class="div_window" id="div_qrcode_window" style="display: none;"></div>
	</div>
	<div class="div_loading" style="display: none;">
		<i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
		<div>Connect BSC Wallet...</div>
	</div>
	
	<textarea id="from_select_template" style="display:none;">
		<div class="div_window_header">Swap from ...<i class="fa fa-times" aria-hidden="true"></i></div>
		{#foreach $T.coins as coin}
			<div coin="{$T.coin}" class="div_select_item {#if $T.coin == $T.swapCoin}div_select_item_selected{#/if}">
				<img src="img/coin/{$T.coin}.png"/>
				{#if $T.coin != $T.fromChain.coin}
					<img src="img/coin/{$T.fromChain.coin}.png" class="min-img"/>
				{#/if}
				<div>
					<div>{$T.coin}</div>
					{#if $T.coin != $T.fromChain.coin}
						<div class="chain">{$T.fromChain.chain}</div>
					{#else}
						<div class="chain">Native</div>
					{#/if}
				</div>
			</div>
		{#/for}
	</textarea>
	<textarea id="to_select_template" style="display:none;">
		<div class="div_window_header">Swap to ...<i class="fa fa-times" aria-hidden="true"></i></div>
		{#foreach $T.chains as chain}
			{#if $T.chain.coin != $T.fromChain.coin && $T.chain.addresses[$T.swapCoin] != null}
				<div coin="{$T.chain.coin}" class="div_select_item {#if $T.chain.coin == $T.toChain.coin}div_select_item_selected{#/if}">
					<img src="img/coin/{$T.swapCoin}.png"/>
					{#if $T.chain.coin != $T.swapCoin}
						<img src="img/coin/{$T.chain.coin}.png" class="min-img"/>
					{#/if}
					<div>
						<div>{$T.swapCoin}</div>
						{#if $T.chain.coin != $T.swapCoin}
							<div class="chain">{$T.chain.chain}</div>
						{#else}
							<div class="chain">Native</div>
						{#/if}
					</div>
				</div>
			{#/if}
		{#/for}
	</textarea>
	<textarea id="qrcode_window_template" style="display:none;">
		<div class="div_window_header">Scanning QR code ...<i class="fa fa-times" aria-hidden="true"></i></div>
		<div style="width:150px; margin: auto; margin-top: 30px; text-align: center;">
			<div id="address_qr"></div>
		</div>
		<div class="" style="width: 290px; margin: auto; margin-top: 15px;">
			<div class="">
				<input id="input_paymentAddr" type="text" name="lp" class="" value=""/>
			</div>
		</div>
		<div class="" style="width: 30px; margin: 10px auto 15px auto;">
			<button data-clipboard-target="#input_paymentAddr" class="btn_copy"><span>Copy</span></button>
		</div>
	</textarea>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.3.4/dist/web3.min.js"></script>
	<script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="js/jquery-jtemplates.js"></script>
	<script type="text/javascript" src="js/jquery.qrcode.min.js"></script>
	<script type="text/javascript" src="js/clipboard.min.js" ></script>
	<script type="text/javascript" src="js/base.js" ></script>
	<script type="text/javascript" src="js/config.js" ></script>
	<script type="text/javascript">
		$(function () {
			$.closeWindow = function(){
				$(".div_overlay").hide();
				$(".div_window").hide();
			};
			$(".div_from_btn").on('click', function(){
				$(".div_overlay").show();
				$("#div_from_select").show();
			});
			$(".div_to_btn").on('click', function(){
				$(".div_overlay").show();
				$("#div_to_select").show();
			});
			$(".div_overlay").on('click', function(){
				$(".div_window_header i").click();
			});
			var rate = 1;
			$("#input_from_amount").on('input', function(){
				$("#input_to_amount").val($(this).val() * rate);
			});
			$("#input_from_addr").on('input', function(){
				if ($.config.fromChain.chainId != null && $.config.toChain.chainId != null) {
					$("#input_to_addr").val($(this).val());
					$("#input_to_addr").attr("disabled", "disabled");
				}
			});
			
			
			
			// init
			$.init = function() {
				// logo
				$("#img_from").attr("src", $.logo($.config.swapCoin));
				if ($.config.swapCoin == $.config.fromChain.coin) {
					$("#img_from_chain").hide();
				} else {
					$("#img_from_chain").show();
					$("#img_from_chain").attr("src", $.logo($.config.fromChain.coin));
				}
				$("#img_to").attr("src", $.logo($.config.swapCoin));
				if ($.config.swapCoin == $.config.toChain.coin) {
					$("#img_to_chain").hide();
				} else {
					$("#img_to_chain").show();
					$("#img_to_chain").attr("src", $.logo($.config.toChain.coin));
				}
				
				// show select window
				$("#div_from_select").setTemplateElement("from_select_template");
				$("#div_from_select").processTemplate($.config);
				$("#div_to_select").setTemplateElement("to_select_template");
				$("#div_to_select").processTemplate($.config);
				$(".div_window_header i").on('click', $.closeWindow);
				
				// click select window
				$("#div_from_select .div_select_item").each(function(){
					var that = $(this);
					that.on('click', function(){
						for (var coin of $.config.coins) {
							if (coin == that.attr("coin")) {
								$.config.swapCoin = coin;
								$.init();
								$(".div_window_header i").click();
								break;
							}	
						}
					});
				});
				$("#div_to_select .div_select_item").each(function(){
					var that = $(this);
					that.on('click', function(){
						for (var chain of $.config.chains) {
							if (chain.coin == that.attr("coin")) {
								$.config.toChain = chain;
								$.init();
								if ($.config.toChain.chainId == null) {
									$("#input_to_addr").val("");
									$("#input_to_addr").removeAttr("disabled");
								} else if ($.config.fromChain.chainId != null) {
									$("#input_to_addr").val($("#input_from_addr").val());
									$("#input_to_addr").attr("disabled", "disabled");
								}
								$(".div_window_header i").click();
								break;
							}
						}
					});
				});
			};
			$.init();
			
			// verify chainId
			$.verifyChainId = async function(chainId, callback, errorCallback) {
				const currChainId = await window.ethereum.request({ method: 'eth_chainId' });
				if (chainId == currChainId) {
					if (callback) callback();
				} else {
					if (errorCallback) errorCallback();
				}
			}
			
			// switch wallet
			var web3;
			var walletAddress;
			$.switchWallet = function(address) {
				walletAddress = address;
				$("#input_from_addr").val(walletAddress);
				$("#input_from_addr").attr("disabled", "disabled");
				if ($.config.toChain.chainId != null) {
					$("#input_to_addr").val(walletAddress);
					$("#input_to_addr").attr("disabled", "disabled");
				}
			};
			
			// waitForReceipt
			$.waitForReceipt = async function(tx_hash, max_try, cb) {
				if (max_try <= 0) {
					$.dialog("waitForReceipt timeout", 1000);
					return;
				}
				let receipt = await web3.eth.getTransactionReceipt(tx_hash);
				if (receipt != null) {
					cb(receipt);
				} else {
					await $.sleep(1500);
					$.waitForReceipt(tx_hash, max_try - 1, cb);
				}
			};
			$.sleep = function(ms) {
				return new Promise((resolve) => {
					setTimeout(resolve, ms);
				});
			};
			
			// access contract
			const ERC20_ABI = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
			const ETH_USDT_ABI = [{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"}];
			$.transfer = function(data) {
				if ($.config.swapCoin == $.config.fromChain.coin) {
					var message = {from: walletAddress, to: data.paymentAddr, value: web3.utils.toWei(data.fromAmount, 'ether')};
					web3.eth.sendTransaction(message, (err, res) => {
				        if (err) {
				        	$.dialog("error", 1000);
				        } else {
				        	$.submit(data);
				        }
				    });
				} else {
					var isEthUsdt = $.config.swapCoin == "USDT" && $.config.fromChain.coin == "ETH" ? true : false;
					var contractAddr = $.config.fromChain.addresses[$.config.swapCoin];
					var contract = new web3.eth.Contract(isEthUsdt ? ETH_USDT_ABI : ERC20_ABI, contractAddr);
					contract.methods
						.transfer(data.paymentAddr, web3.utils.toWei(data.fromAmount, isEthUsdt ? "Mwei" : "ether"))
						.send({from: walletAddress})
						.then((tx) => {
							$.waitForReceipt(tx.transactionHash, 6, (receipt) => {
								$.submit(data);
							});
						});
				}
			};
			
			// not connect submit
			$.notConnect = function() {
				$(".btn_submit").on('click', function(){
					$.queryPaymentAddr(function(paymentAddr){
						$("#div_qrcode_window").setTemplateElement("qrcode_window_template");
						$("#div_qrcode_window").processTemplate($.config);
						$(".div_window_header i").on('click', $.closeWindow);
						
						var addressQr = $('#address_qr');
						if (addressQr.length > 0) {
							addressQr.html("");
							addressQr.qrcode({
								text: paymentAddr,
								width: 150,
								height: 150,
								correctLevel: 0,
								background: "#ffffff",
							    foreground: "#32b1f5"
							});
							$("#input_paymentAddr").val(paymentAddr);
							$.copy('.btn_copy');
						}
						
						$(".div_overlay").show();
						$("#div_qrcode_window").show();
					});
				});
			};
			
			// request
			$.getSubmitData = function(paymentAddr) {
				// from address
				var fromAmount = $("#input_from_amount").val();
				if (! fromAmount) {
					$.dialog('No from amount entered', 1000);
					return null;
				}
				
				// to address
				var toAmount = $("#input_to_amount").val();
				if (! toAmount) {
					$.dialog('No to amount entered', 1000);
					return null;
				}
				
				// from address
				var fromAddr = $("#input_from_addr").val();
				if (! fromAddr) {
					$.dialog("No from address entered", 1000);
					return null;
				}
				
				// to address
				var toAddr = $("#input_to_addr").val();
				if (! toAddr) {
					$.dialog("No to address entered", 1000);
					return null;
				}
				
				// data
				var data = {
						paymentAddr: paymentAddr,
						fromChain: $.config.fromChain.coin, 
						toChain: $.config.toChain.coin,
						fromAmount: fromAmount,
						toAmount: toAmount,
						fromAddr: fromAddr,
						toAddr: toAddr
				};
				return data;
			};
			$.submit = function(data) {
				$.ajax({
					type: "post",
					url: "/api/save",
					data: data,
					dataType : "jsonp",
					traditional: true,
					success: function(msg){
					}
				});
			};
			$.queryPaymentAddr = function(callback){
				callback("0xe5Bd21f0F3F35F1FF34ccC22AB84AFaFA30028B3");
				
				// $.ajax({
				// 	type: "get",
				// 	url: "/api/paymentAddr",
				// 	data: {chain: "BNB"},
				// 	dataType : "jsonp",
				// 	traditional: true,
				// 	success: function(paymentAddr){
				// 		callback(paymentAddr);
				// 	}
				// });
			};
			
			// connect wallet
			if (window.ethereum) {
				try {
					window.ethereum.enable().then(accounts => {
						$.verifyChainId($.config.fromChain.chainId, function(){
							web3 = new Web3(window.ethereum);
							window.ethereum.on("accountsChanged", function(accounts) {
								$.switchWallet(accounts[0]);
							});
							$.switchWallet(accounts[0]);
							
							// event
							$(".btn_submit").on('click', function() {
								$.queryPaymentAddr(function(paymentAddr){
									var data = $.getSubmitData(paymentAddr);
									if (! data) return;
									$.transfer(data);
								});
							});
						}, $.notConnect);
					});
				} catch (error) {
					$.dialog(error, 1000);
					$.notConnect();
				}
			} else {
				$.notConnect();
			}
		});
	</script>
</body>
</html>